{% extends 'base.html' %}
{% load static %}
{% block title %} Jobs {% endblock title %}

{% block stylesheets %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<!-- Add this inside your base template or head section -->

<style>
  /* Full-width container without max-width */
  .stats-and-search {
      width: 100%;
      padding: 20px;
      background-color: #ccd7c5;
      border-radius: 20px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      margin: auto;
  }

  /* Stats section flex alignment */
  .stats-row {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
  }

  .stats-row .card {
      flex: 1;
      min-width: 150px;
  }

  /* Search bar styling for full width */
  .search-bar {
      display: flex;
      align-items: center;
      width: 100%;
      background-color: white;
      border-radius: 50px;
      overflow: visibile;
      padding: 15px;
      box-shadow: 4px 4px 8px rgba(0, 0, 0, 0.1);
      border: none;
  }

  /* Input field container */
  .input-container {
      position: relative;
      flex: 1;
      overflow: visibile;
  }


/* General input styling for both inputs */
.input-container input[type="text"] {
  width: 100%;
  padding: 15px 20px 15px 45px; /* Padding is the same for both inputs */
  font-size: 1em;
  border: none;
  color: #333;
  outline: none;
  height: 100%;
  background-color: #ffffff; /* Ensure both have the same background color */
}

/* Left input field styling */
.input-container.left input[type="text"] {
  border-radius: 50px 0 0 50px; /* Rounded left side, sharp right edge */
}

/* Right input field styling */
.input-container.right input[type="text"] {
  border-radius: 0 50px 50px 0; /* Sharp left edge, rounded right side */
}

  /* Icon styling */
  .input-container .icon {
    position: absolute;
    top: 50%;
    left: 15px;
    transform: translateY(-50%);
    color: #999;
    font-size: 1.2em;
}

  /* Remove focus outline */
  .input-container input[type="text"]:focus {
      outline: none;
  }

  /* Search Button */
  .search-bar button {
      background-color: #4e00ff;
      color: white;
      border: none;
      padding: 15px 30px;
      font-size: 1em;
      cursor: pointer;
      border-radius: 50px;
      flex-shrink: 0;
  }

  /* Divider line between input fields */
  .input-container.right {
    border-left: 1px solid #e0e0e0; /* Consistent divider line */
  }

  /* Mobile view adjustments */
  @media (max-width: 768px) {
      /* Stack the search inputs vertically */
      .search-bar {
          flex-direction: column;
          padding: 10px;
          border-radius: 20px;
          background-color: #ccd7c5;
          box-shadow: none; /* Remove shadow */
      }

      .input-container {
          width: 100%;
          margin-bottom: 10px; /* Space between stacked inputs */
      }

      .input-container.left input[type="text"],
      .input-container.right input[type="text"] {
          border-radius: 5px; /* Rounded corners for all inputs in mobile */
      }

      .input-container.right {
          border-left: none; /* Remove divider line in mobile */
      }

      /* Center the search button below the inputs */
      .search-bar button {
          width: 100%;
          margin-top: 10px;
          border-radius: 20px;
      }

      /* Adjust icon position for smaller screen */
      .input-container .icon {
          font-size: 1em;
          left: 10px;
      }

      /* Adjust input padding for smaller screen */
      .input-container input[type="text"] {
          padding: 12px 15px 12px 35px;
          font-size: 0.9em;
      }
  }



  /* Auto complerte css */



  .form-group {
    position: relative;
  }


  .autocomplete-result:hover {
    background-color: #4e00ff; /* Navy blue color on hover */
    color: #ffffff; /* White text color for better contrast */
  }


  .selected-skills-container {
    margin-top: 10px;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }
  
  .skill-tag {
    display: inline-flex;
    align-items: center;
    background-color: #4e00ff; /* Use the same color as your theme */
    color: white;
    padding: 8px 12px;
    border-radius: 15px;
    font-size: 0.9em;
  }
  
  .remove-skill {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    margin-left: 10px;
    font-weight: bold;
    font-size: 1.2em;
  }
  
  .remove-skill:hover {
    color: #ff0000; /* Optional: highlight the remove button on hover */
  }
  
  .selected-companies-container {
    margin-top: 10px;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }
  
  .company-tag {
    display: inline-flex;
    align-items: center;
    background-color: #4e00ff; /* Use the same color as your theme */
    color: white;
    padding: 8px 12px;
    border-radius: 15px;
    font-size: 0.9em;
  }
  
  .remove-company {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    margin-left: 10px;
    font-weight: bold;
    font-size: 1.2em;
  }
  
  .remove-company:hover {
    color: #ff0000; /* Optional: highlight the remove button on hover */
  }

</style>

{% endblock stylesheets %}

{% block content %}

<div class="container-fluid py-4">
  <!-- Stats and Search Bar Section -->
  <div class="stats-and-search">

    <!-- Stats Row -->
    <div class="stats-row" style="margin-top:20px;">
      <div class="card">
        <div class="card-body p-3">
          <p class="text-sm mb-0 font-weight-bold">Today's New</p>
          <h5 class="font-weight-bolder mb-0">
            {{ new_jobs }}
            <span class="text-success text-sm font-weight-bolder">{{ new_jobs_perc|floatformat:1 }}%</span>
          </h5>
        </div>
      </div>

      <div class="card">
        <div class="card-body p-3">
          <p class="text-sm mb-0 font-weight-bold">Total Available</p>
          <h5 class="font-weight-bolder mb-0">
            {{ total_jobs }}
            {% if total_jobs_change_positive %}
              <span class="text-success text-sm font-weight-bolder">+{{ total_jobs_change }}%</span>
            {% else %}
              <span class="text-danger text-sm font-weight-bolder">-{{ total_jobs_change }}%</span>
            {% endif %}
          </h5>
        </div>
      </div>
    </div>

    <!-- Search Bar -->
    <form method="GET" action="{% url 'jobs' %}">
      <div class="search-bar">
          <!-- Title/Keyword Input with Autocomplete -->
          <!-- Title/Keyword Input with Autocomplete -->
          <div id="title_keyword_container" class="input-container left autocomplete" style="flex: 2; position: relative;">
            <i class="fas fa-search icon"></i>
            <input type="text" name="title_keyword" id="title_keyword_input" placeholder="Job title or keyword" autocomplete="off" class="autocomplete-input" />
            <ul id="keyword-autocomplete" class="autocomplete-result-list"></ul>
          </div>
    
          <!-- Location Input with Autocomplete --> 
          <div id="location" class="input-container right autocomplete" style="flex: 1; position: relative;">
            <i class="fas fa-map-marker-alt icon"></i>
            <input type="text" name="location" id="location" placeholder="Add country or city" autocomplete="off" />
            <ul id="location-autocomplete" class="autocomplete-result-list"></ul>
          </div>
    
          <button type="submit">Search</button>
      </div>
    </form>

        
    
  </div>

  <!-- Filter and Job Listings -->
  <div class="row mt-3">
    <div class="col-md-3">
      <div class="card">
        <div class="card-body">
          <h6 class="font-weight-bold">Filters</h6>
    
          <!-- Category Filter -->
          <div class="form-group">
            <label for="job-category">Category</label>
            <select class="form-control" id="job-category" name="category">
              <option value="">All Categories</option>
              <option value="IT">IT</option>
              <option value="Marketing">Marketing</option>
              <option value="Finance">Finance</option>
              <!-- Add more categories as needed -->
            </select>
          </div>
    
          <!-- Sub-Category Filter -->
          <div class="form-group">
            <label for="job-sub-category">Sub-Category</label>
            <select class="form-control" id="job-sub-category" name="sub_category">
              <option value="">All Sub-Categories</option>
              <!-- Populate sub-categories dynamically if needed -->
              <option value="Software Development">Software Development</option>
              <option value="Content Marketing">Content Marketing</option>
              <option value="Accounting">Accounting</option>
              <!-- Add more sub-categories as needed -->
            </select>
          </div>
    
          <!-- Skills Filter -->
          <div id="skills" class="form-group autocomplete">
            <label for="skills">Skills</label>
            <input type="text" name="skills" id="skills_input" placeholder="Search for skills" autocomplete="off" class="form-control autocomplete-input" />
            <ul id="skills-autocomplete" class="autocomplete-result-list"></ul>
            <div id="selected-skills" class="selected-skills-container"></div>
          </div>           
    
          <div id="company" class="form-group autocomplete">
            <label for="company_input">Company</label>
            <input type="text" name="company" id="company_input" placeholder="Search for company" autocomplete="off" class="form-control autocomplete-input" />
            <ul id="company-autocomplete" class="autocomplete-result-list"></ul>
            <div id="selected-companies" class="selected-companies-container"></div>
          </div>

          <!-- Date Filter -->
          <div class="form-group">
            <label for="date-filter">Date Posted</label>
            <select class="form-control" id="date-filter" name="date">
              <option value="">Anytime</option>
              <option value="last_24_hours">Last 24 hours</option>
              <option value="last_7_days">Last 7 days</option>
              <option value="last_30_days">Last 30 days</option>
            </select>
          </div>
    
          <!-- Remote/In-Office Filter -->
          <div class="form-group">
            <label>Work Type</label>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="remote" name="remote" value="true">
              <label class="form-check-label" for="remote">Remote</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="in-office" name="in_office" value="true">
              <label class="form-check-label" for="in-office">In Office</label>
            </div>
          </div>
    
          <!-- Apply Filters Button -->
          <button type="submit" class="btn btn-primary w-100">Apply Filters</button>
        </div>
      </div>
    </div>
    

    <div class="col-md-9">
      <div class="card">
        <div class="card-body">
          <h6 class="font-weight-bold">Job Listings</h6>
          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr>
                  <th>Company</th>
                  <th>Title / Department</th>
                  <th>Location</th>
                  <th>Job URL</th>
                  <th>Reviewed</th>
                  <th>Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for job in jobs_list %}
                  <tr>
                    <td>{{ job.company.name }}</td>
                    <td>{{ job.title }} / {{ job.category }}</td>
                    <td>{% for location in job.location.all %}{{ location.city }}, {{ location.country }}{% endfor %}</td>
                    <td><a href="{{ job.job_url }}" target="_blank">Link</a></td>
                    <td>{{ job.reviewed|yesno:"Yes,No" }}</td>
                    <td>{{ job.date|date:"M d, Y" }}</td>
                    <td>
                      <a href="{% url 'job_detailed_view' job.id %}" class="btn btn-sm btn-info">View</a>
                      <a href="{% url 'job_update_view' job.id %}" class="btn btn-sm btn-warning">Edit</a>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock content %}


{% block javascripts %}
<script>

  // Autocomplete for location input (new functionality)
  new Autocomplete('#location', {
    search: input => {
        const url = "{% url 'autocomplete_locations' %}?q=" + input;
        return new Promise(resolve => {
            fetch(url)
            .then(response => response.json())
            .then(data => {
                resolve(data.data);
            });
        });
    }
  });

  // Initialize autocomplete for the keyword input field
  new Autocomplete('#title_keyword_container', {
    search: input => {
      // Assuming you have a URL endpoint that provides keyword suggestions
      const url = "{% url 'autocomplete_title_keywords' %}?q=" + input;
      return new Promise(resolve => {
        fetch(url)
          .then(response => response.json())
          .then(data => {
            resolve(data.data); // Assuming response format: { status: 200, data: [...] }
          })
      });
    },
  });


// Initialize autocomplete for the skills input field
// Initialize autocomplete for the skills input field
new Autocomplete('#skills', {
  search: input => {
    // Assuming you have a URL endpoint that provides skill suggestions
    const url = "{% url 'autocomplete_skills' %}?q=" + input;
    return new Promise(resolve => {
      fetch(url)
        .then(response => response.json())
        .then(data => {
          resolve(data.data); // Assuming response format: { status: 200, data: [...] }
        });
    });
  },
  onSubmit: result => {
    if (result) {
      // Add the selected skill to the "selected-skills" container
      const selectedSkillsContainer = document.getElementById("selected-skills");

      // Check if the skill is already added using data-skill-name attribute
      const isAlreadyAdded = Array.from(selectedSkillsContainer.children).some(skillTag => {
        return skillTag.dataset.skillName === result; // Compare with the data attribute value
      });

      if (isAlreadyAdded) {
        return; // Skip adding the skill if it already exists
      }

      // Create a new span for the selected skill
      const skillTag = document.createElement("span");
      skillTag.className = "skill-tag";
      skillTag.textContent = result;
      skillTag.dataset.skillName = result; // Use data attribute to store the skill name uniquely

      // Add a remove button for each skill
      const removeButton = document.createElement("button");
      removeButton.className = "remove-skill";
      removeButton.innerHTML = "&times;";
      removeButton.addEventListener("click", () => {
        selectedSkillsContainer.removeChild(skillTag);
      });

      // Append the remove button to the skill tag and add the skill tag to the container
      skillTag.appendChild(removeButton);
      selectedSkillsContainer.appendChild(skillTag);

      // Do not clear the input field; allow adding multiple skills
      document.getElementById('skills_input').value = "";
    }
  },
});

// Initialize autocomplete for the company input field
// Initialize autocomplete for the company input field
new Autocomplete('#company', {
  search: input => {
    // Assuming you have a URL endpoint that provides company suggestions
    const url = "{% url 'autocomplete_companies' %}?q=" + input;
    return new Promise(resolve => {
      fetch(url)
        .then(response => response.json())
        .then(data => {
          resolve(data.data); // Assuming response format: { status: 200, data: [...] }
        });
    });
  },
  onSubmit: result => {
    if (result) {
      // Add the selected company to the "selected-companies" container
      const selectedCompaniesContainer = document.getElementById("selected-companies");

      // Check if the company is already added using data-company-name attribute
      const isAlreadyAdded = Array.from(selectedCompaniesContainer.children).some(companyTag => {
        return companyTag.dataset.companyName === result; // Compare with data attribute value
      });

      if (isAlreadyAdded) {
        return; // Skip adding the company if it already exists
      }

      // Create a new span for the selected company
      const companyTag = document.createElement("span");
      companyTag.className = "company-tag";
      companyTag.textContent = result;
      companyTag.dataset.companyName = result; // Use data attribute to store the company name

      // Add a remove button for each company
      const removeButton = document.createElement("button");
      removeButton.className = "remove-company";
      removeButton.innerHTML = "&times;";
      removeButton.addEventListener("click", () => {
        selectedCompaniesContainer.removeChild(companyTag);
      });

      // Append the remove button to the company tag and add the company tag to the container
      companyTag.appendChild(removeButton);
      selectedCompaniesContainer.appendChild(companyTag);

      // Do not clear the input field; allow adding multiple companies
      document.getElementById('company_input').value = "";
    }
  }
});



</script>
{% endblock javascripts %}